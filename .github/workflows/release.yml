name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write
  packages: write

jobs:
  detect-changes:
    name: Detect Changed Packages
    runs-on: ubuntu-latest
    outputs:
      backend_changed: ${{ steps.changed-files.outputs.backend_any_changed }}
      threads_changed: ${{ steps.changed-files.outputs.threads_any_changed }}
      react_glass_changed: ${{ steps.changed-files.outputs.react_glass_any_changed }}
      react_markdown_changed: ${{ steps.changed-files.outputs.react_markdown_any_changed }}
      documents_changed: ${{ steps.changed-files.outputs.documents_any_changed }}
      facets_changed: ${{ steps.changed-files.outputs.facets_any_changed }}
      any_changed: ${{ steps.check-any.outputs.any_changed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files_yaml: |
            backend:
              - 'packages/backend/**'
            threads:
              - 'packages/threads/**'
            react_glass:
              - 'packages/react-glass/**'
            react_markdown:
              - 'packages/react-markdown/**'
            documents:
              - 'packages/documents/**'
            facets:
              - 'packages/facets/**'

      - name: Check if any package changed
        id: check-any
        run: |
          if [ "${{ steps.changed-files.outputs.backend_any_changed }}" == "true" ] || \
             [ "${{ steps.changed-files.outputs.threads_any_changed }}" == "true" ] || \
             [ "${{ steps.changed-files.outputs.react_glass_any_changed }}" == "true" ] || \
             [ "${{ steps.changed-files.outputs.react_markdown_any_changed }}" == "true" ] || \
             [ "${{ steps.changed-files.outputs.documents_any_changed }}" == "true" ] || \
             [ "${{ steps.changed-files.outputs.facets_any_changed }}" == "true" ]; then
            echo "any_changed=true" >> $GITHUB_OUTPUT
          else
            echo "any_changed=false" >> $GITHUB_OUTPUT
          fi

  release:
    name: Release Changed Packages
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any_changed == 'true'
    environment: release
    strategy:
      matrix:
        package:
          - name: backend
            path: packages/backend
            changed: ${{ needs.detect-changes.outputs.backend_changed }}
          - name: threads
            path: packages/threads
            changed: ${{ needs.detect-changes.outputs.threads_changed }}
          - name: react-glass
            path: packages/react-glass
            changed: ${{ needs.detect-changes.outputs.react_glass_changed }}
          - name: react-markdown
            path: packages/react-markdown
            changed: ${{ needs.detect-changes.outputs.react_markdown_changed }}
          - name: documents
            path: packages/documents
            changed: ${{ needs.detect-changes.outputs.documents_changed }}
          - name: facets
            path: packages/facets
            changed: ${{ needs.detect-changes.outputs.facets_changed }}
    steps:
      - name: Checkout repository
        if: matrix.package.changed == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup pnpm
        if: matrix.package.changed == 'true'
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        if: matrix.package.changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        if: matrix.package.changed == 'true'
        run: pnpm install --frozen-lockfile

      - name: Build package
        if: matrix.package.changed == 'true'
        run: pnpm --filter @tetraship/${{ matrix.package.name }} build

      - name: Semantic Release
        if: matrix.package.changed == 'true'
        uses: cycjimmy/semantic-release-action@v4
        with:
          working_directory: ${{ matrix.package.path }}
          semantic_version: 19
          extra_plugins: |
            @semantic-release/changelog
            @semantic-release/git
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}